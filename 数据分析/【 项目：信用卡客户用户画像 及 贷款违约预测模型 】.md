# ã€ä»¥ä¸‹ä¸ºæœ¬é¡¹ç›®åˆ†ææ€ç»´å¯¼å›¾ï¼šã€‘[Â¶](#ã€ä»¥ä¸‹ä¸ºæœ¬é¡¹ç›®åˆ†ææ€ç»´å¯¼å›¾ï¼šã€‘)

é¡¹ç›®å·¥å…·ï¼šPycharm + Navicat æˆ– åœ¨çº¿å·¥å…·freego

![Image Name](https://cdn.kesci.com/upload/image/qbe38xnfsu.png)

**æ¥ä¸‹æ¥è¿›è¡Œä»£ç æ¼”ç¤º**

# ã€é¡¹ç›® ğŸ”º ğŸ”ºï¼ˆç»¼åˆç‰ˆï¼‰ï¼šä¿¡ç”¨å¡å®¢æˆ·ç”¨æˆ·ç”»åƒ åŠ è´·æ¬¾è¿çº¦é¢„æµ‹æ¨¡å‹ã€‘[Â¶](#ã€é¡¹ç›®-ğŸ”º-ğŸ”ºï¼ˆç»¼åˆç‰ˆï¼‰ï¼šä¿¡ç”¨å¡å®¢æˆ·ç”¨æˆ·ç”»åƒ-åŠ-è´·æ¬¾è¿çº¦é¢„æµ‹æ¨¡å‹ã€‘)

# --ã€ æ•°æ®ç†è§£ ã€‘--[Â¶](#--ã€-æ•°æ®ç†è§£-ã€‘--)

# (ä¸€) å¯¼å…¥æ•°æ® å¹¶è¿›è¡Œåˆæ­¥çš„æ•°æ®è§‚å¯Ÿ[Â¶](#(ä¸€)-å¯¼å…¥æ•°æ®-å¹¶è¿›è¡Œåˆæ­¥çš„æ•°æ®è§‚å¯Ÿ)

## 1.æ”¹å˜å·¥ä½œç›®å½•åˆ° æ•°æ®é›†æ‰€åœ¨æ–‡ä»¶å¤¹[Â¶](#1.æ”¹å˜å·¥ä½œç›®å½•åˆ°-æ•°æ®é›†æ‰€åœ¨æ–‡ä»¶å¤¹)

In [ ]:

```
# -*- coding:utf-8 -*-

import  pandas as pd    # ç”¨äº æ•°æ®æ¸…æ´— å’Œ æ•°æ®æ•´ç†
import os   # å·¥ä½œè·¯å¾„ åŠ æ–‡ä»¶å¤¹æ“ä½œ
import datetime

pd.set_option('display.max_columns',None)

# åˆ†åˆ«è®¾ç½®å¥½ æ•°æ®é›†è·¯å¾„ å’Œ ä¹‹åä¿å­˜ç”Ÿæˆçš„æ–‡ä»¶ çš„è·¯å¾„

data_path = r'D:\Data_Sets_of_Analysis\Project_1_Analysis_of_Credit_Card_User_Portrait_and_Personal_Loan_Overdue\Data_Set_of_Credit_Card_User_Portrait_and_Personal_Loan_Overdue'
save_file_path = r'D:\Data_Sets_of_Analysis\Project_1_Analysis_of_Credit_Card_User_Portrait_and_Personal_Loan_Overdue'
os.chdir(data_path)
load_file = os.listdir()

print('\n' + '-'*25 + 'æ‰“å°ç›®å½•åˆ—è¡¨' + '-'*25)   # æç¤ºæ€§åˆ†å‰²çº¿ï¼Œæ–¹ä¾¿é˜…è¯»
print(load_file)    # æ‰“å°ç›®å½•åˆ—è¡¨
print('\n'*2 + '='*100)  # æ‰“å°æ¨¡å—åˆ†å‰²çº¿ï¼Œæ–¹ä¾¿é˜…è¯»
```

## 2.åˆ©ç”¨pandasè¯»å–csvæ–‡ä»¶[Â¶](#2.åˆ©ç”¨pandasè¯»å–csvæ–‡ä»¶)

In [2]:

```
'''
ã€ #%% ã€‘ æ‰“å¼€ View â†’ Scientific Model åç‚¹å‡»å…¶å·¦è¾¹çš„ç»¿è‰²å‰ªå¤´ å¯åˆ†å—æ‰§è¡Œ
'''


# # å› æ–‡ä»¶è¾ƒå¤šï¼Œæ•…é‡‡ç”¨forå¾ªç¯ç»“åˆlocalså‡½æ•°åŠ¨æ€ç”Ÿæˆå¤šä¸ªå˜é‡

table_name = []
columns_name_express = []
columns_name = []
sql_statement = []
dataframe_table_columns_name = pd.DataFrame(columns=['è¡¨å','åˆ—å'])    # ç”Ÿæˆä¸€ä¸ªç©ºçš„DataFrameï¼Œå…¶åˆ—åä¸º'è¡¨å'å’Œ'åˆ—å'

for i in load_file:

    # ä»…è¯»å–åç¼€ä¸ºcsvçš„è¡¨
    if i.split('.')[1] == 'csv':

        # locals()æ–¹æ³•åŠ¨æ€ç”Ÿæˆå¤šä¸ªå˜é‡
        locals()[i.split('.')[0]] = pd.read_csv(i,encoding='gbk',error_bad_lines=False,low_memory=False)

        # å°† æ¯ä¸€ä¸ªè¡¨çš„åå­— éƒ½æ·»åŠ åˆ° table_name åˆ—è¡¨ä¸­
        table_name.append(i.split('.')[0])

        # å°† æ¯ä¸€ä¸ªè¡¨çš„åå­— è¿åŒ æ¯ä¸€åˆ—çš„åå­—éƒ½æ·»åŠ åˆ° columns_name_express å’Œ columns_name åˆ—è¡¨ä¸­
        columns_name.append(list(locals()[i.split('.')[0]]))
        columns_name_express.append([i.split('.')[0] + 'è¡¨çš„åˆ—åå¦‚ä¸‹ï¼š' + str(list(locals()[i.split('.')[0]])) + '\n' + '-'*125])
        '''
        i.split('.')[0] â†’ æ¯ä¸€ä¸ªè¡¨çš„åå­—
        str(list(locals()[i.split('.')[0]])) â†’ 1.locals[]ä¸­å¡«å…¥è¡¨ç¤º è¡¨å çš„i.split('.')[0]ï¼Œè¡¨ç¤ºé€‰ä¸­è¯¥localsä¸­çš„è¯¥è¡¨
                                               2.list(DataFrame)è¡¨ç¤ºDataFrameçš„åˆ—åï¼Œæ•…list(locals()[i.split('.')[0]])
                                                 è¡¨ç¤ºçš„æ˜¯ å– è¡¨å ä¸ºi.split('.')[0] çš„ è¡¨ çš„ åˆ—å
                                               3.æœ€åå› ä¸ºè¦è¿æ¥å­—ç¬¦ä¸²ï¼Œæ‰€ä»¥ç”¨str()å‡½æ•°å°†ä»¥ä¸Šè¿›è¡Œè½¬æ¢
        '\n'  â†’ è¡¨ç¤ºæ¢è¡Œ
        '-'*125 â†’ å°†å­—ç¬¦ä¸²- ä¹˜ä»¥125 è¡¨ç¤ºæ‰“å° - 125æ¬¡  ä½œç”¨ä¸ºç”»ä¸€ä¸ªåˆ†å‰²çº¿ï¼Œæ–¹ä¾¿è§‚å¯Ÿï¼Œä¸æ˜“ä¸²è¡Œ
        æœ€åå°†ä»¥ä¸Šå­—æ®µè½¬æ¢ä¸ºåˆ—è¡¨ï¼Œç”¨appendæ·»åŠ åˆ° columns_name ä¸­
        '''

        # ä¸ºæ–¹ä¾¿ç”¨åœ¨çº¿å·¥å…·ç”»ERå›¾ï¼Œåœ¨æ­¤é¡ºä¾¿ç”Ÿæˆsqlè¯­å¥
        tn_str =''
        for j in range(len(list(locals()[i.split('.')[0]]))):
            tn_str += '\n' + list(locals()[i.split('.')[0]])[j] + ' ' + 'TEXT' + ','
        sql_statement.append('CREATE TABLE' + ' ' + i.split('.')[0] + '\n' + '(' + tn_str.strip(',') + '\n' + ');')

        # ç”Ÿæˆä¸€ä¸ª è¡¨æ ¼ã€åˆ—åé€è§†è¡¨ å¹¶è¾“å‡ºexcelæ–‡ä»¶ æ–¹ä¾¿ä½œ åˆ—ååˆ†æ
        dataframe_table_columns_name = dataframe_table_columns_name.append(pd.DataFrame({'è¡¨å':i.split('.')[0],'åˆ—å':columns_name[-1]}))
        
```

## 3.ç”Ÿæˆsqlè¯­å¥[Â¶](#3.ç”Ÿæˆsqlè¯­å¥)

In [ ]:

```
# ç”Ÿæˆsqlè¯­å¥ï¼Œå¤åˆ¶åè¿›å…¥freegoé€šè¿‡å¯¼å…¥MySQL DDLè‡ªåŠ¨ç”ŸæˆERè¡¨æ ¼ï¼Œå†æ·»åŠ å…³ç³»çº¿å³å¯ç”ŸæˆERå›¾

# # æ³¨é‡Šï¼šåˆ—å±æ€§åœ¨æ­¤ç»Ÿä¸€è®¾ç½®ä¸ºã€ TEXT ã€‘ä»…ä¸ºæ–¹ä¾¿è§‚å¯Ÿä½¿ç”¨

print('åœ¨çº¿MySQLè¯­å¥ç»˜åˆ¶ERå›¾é“¾æ¥ï¼šhttps://www.freedgo.com/erd-index.html,å¤åˆ¶ä»¥ä¸‹ç”Ÿæˆçš„sqlè¯­å¥')
for i in sql_statement:
    print(i)
```

![Image Name](https://cdn.kesci.com/upload/image/qbe1mjf9e3.jpg?imageView2/0/w/960/h/960)

## 4.ç”Ÿæˆä¸€ä¸ª è¡¨æ ¼ã€åˆ—åé€è§†è¡¨ å¹¶è¾“å‡ºexcelæ–‡ä»¶ æ–¹ä¾¿ä½œ åˆ—ååˆ†æ[Â¶](#4.ç”Ÿæˆä¸€ä¸ª-è¡¨æ ¼ã€åˆ—åé€è§†è¡¨-å¹¶è¾“å‡ºexcelæ–‡ä»¶-æ–¹ä¾¿ä½œ-åˆ—ååˆ†æ)

In [ ]:

```
dataframe_table_columns_name['åˆ—åå«ä¹‰åˆ†æ'] = 0  # ä¸ºä½œpivotå›¾ï¼Œå¢åŠ å…¨ä¸º0çš„æ•°å€¼åˆ—ï¼Œä¹‹åå†ç”¨replace()ï¼Œå°†0å…¨éƒ¨æ›¿æ¢ä¸ºç©º
warning = 'ğŸ”º æ³¨æ„ï¼š.to_excelé‡å¤æ‰§è¡Œä¼šè¦†ç›–åŸæœ‰è¡¨ï¼Œæ•…åœ¨æ­£å¼ç¼–è¾‘excelæ—¶åº”æ³¨æ„å¦å­˜ä¸ºæ–°è¡¨ï¼Œæˆ–åˆ›å»ºä¸€ä¸ªå‰¯æœ¬'   # å¢åŠ ä¸€åˆ—æç¤ºï¼Œæ–¹ä¾¿è¡¨æ ¼ä½¿ç”¨
pivot_table_column_name = pd.pivot_table(dataframe_table_columns_name,index=['è¡¨å','åˆ—å']).replace(0,'').append(pd.DataFrame(columns=[warning]))

print('\n'*2 + '='*100)  # æ‰“å°æ¨¡å—åˆ†å‰²çº¿ï¼Œæ–¹ä¾¿é˜…è¯»

# å°†ä»¥ä¸Šå¾—åˆ°çš„è¡¨æ ¼ä¿å­˜åˆ°è·¯å¾„ä¸ºæœ€å¼€å§‹å·²ç»è®¾å®šå¥½çš„ã€ save_file_path ã€‘ä¸­ï¼Œè¡¨æ ¼åç§°ä¸ºã€ åˆ—åå«ä¹‰åˆ†æè¡¨ï¼ˆè¯·å¦å­˜ï¼‰.xls ã€‘
try:
    pivot_table_column_name.to_excel(save_file_path +r'\åˆ—åå«ä¹‰åˆ†æè¡¨ï¼ˆè¯·å¦å­˜ï¼‰.xls')
    print('è¡¨æ ¼å·²ä¿å­˜å®Œæ¯•')
except Exception:
    print('é”™è¯¯ï¼Œâ€˜åˆ—åå«ä¹‰åˆ†æè¡¨ï¼ˆè¯·å¦å­˜ï¼‰.xlsâ€™æœªèƒ½æˆåŠŸä¿å­˜ï¼Œè¯·æ£€æŸ¥æŠ¥é”™åŸå› (å¦‚ï¼šé‡å¤æ‰§è¡Œæ—¶ï¼ŒåŸå…ˆæ–‡ä»¶æ‰“å¼€æœªå…³é—­ï¼Œåˆ™åä¸€æ¬¡æ‰§è¡Œä»£ç æ—¶ï¼Œæ— æ³•è¦†ç›–åŸæ–‡ä»¶æŠ¥é”™)')
```

![Image Name](https://cdn.kesci.com/upload/image/qbe1nq4507.png)

## 5. åˆ—å‡ºåˆšåˆšè¯»å–çš„æ‰€æœ‰è¡¨å[Â¶](#5.-åˆ—å‡ºåˆšåˆšè¯»å–çš„æ‰€æœ‰è¡¨å)

In [ ]:

```
print('\n'*2 + '='*100)  # æ‰“å°æ¨¡å—åˆ†å‰²çº¿ï¼Œæ–¹ä¾¿é˜…è¯»
print('æ‰€æœ‰è¡¨æ ¼çš„åç§°å¦‚ä¸‹ï¼š' + str(table_name))
```

## 6.å°†æ¯ä¸ªè¡¨çš„åˆ—åï¼ˆcolumnï¼‰åˆ†åˆ«æ‰“å°å‡ºæ¥[Â¶](#6.å°†æ¯ä¸ªè¡¨çš„åˆ—åï¼ˆcolumnï¼‰åˆ†åˆ«æ‰“å°å‡ºæ¥)

In [ ]:

```
print('\n'*2 + '='*100)  # æ‰“å°æ¨¡å—åˆ†å‰²çº¿ï¼Œæ–¹ä¾¿é˜…è¯»
for i in range(len(columns_name_express)):
    print(columns_name_express[i][0])
```

## 7.å°†æ¯ä¸ªè¡¨æ ¼çš„å‰5è¡Œæ‰“å°å‡ºæ¥ï¼Œåˆæ­¥è§‚å¯Ÿæ•°æ®[Â¶](#7.å°†æ¯ä¸ªè¡¨æ ¼çš„å‰5è¡Œæ‰“å°å‡ºæ¥ï¼Œåˆæ­¥è§‚å¯Ÿæ•°æ®)

In [ ]:

```
print('\n'*2 + '='*100)  # æ‰“å°æ¨¡å—åˆ†å‰²çº¿ï¼Œæ–¹ä¾¿é˜…è¯»
for tn in load_file:
    col_num = len(list(locals()[tn.split('.')[0]]))
    pd.set_option('display.max_columns', col_num)   # è®¾ç½®æ˜¾ç¤ºæœ€å¤§åˆ—æ•°ä¸º è¡¨çš„åˆ—æ•°
    print('\n' + '-'*25 + 'ä»¥ä¸‹ä¸º%sè¡¨'% tn.split('.')[0] + '-'*25)
    print(locals()[tn.split('.')[0]].head())    # é»˜è®¤æ‰“å°å‰äº”è¡Œ
    print(locals()[tn.split('.')[0]].count())   # æ‰“å°å„åˆ—æ•°æ®æ•°
```

## 8.åˆ›å»ºä¸€ä¸ªå‡½æ•°ç”¨äº æŸ¥è¯¢å¯é€‰å–å€¼ã€ç©ºå€¼[Â¶](#8.åˆ›å»ºä¸€ä¸ªå‡½æ•°ç”¨äº-æŸ¥è¯¢å¯é€‰å–å€¼ã€ç©ºå€¼)

In [ ]:

```
# åˆ›å»ºä¸€ä¸ªå‡½æ•°ç”¨äº æœ‰é€‰æ‹©æ€§åœ° æŸ¥è¯¢ æŸä¸ªè¡¨ ä¸­ æŸä¸ªåˆ— çš„ å¯é€‰å–å€¼ï¼ˆé€šè¿‡è¯¥å‡½æ•°è¿˜èƒ½æŸ¥çœ‹æ˜¯å¦æœ‰ç©ºå€¼ï¼‰
# # 1) å› defä¸­æ— æ³•ç›´æ¥å¼•ç”¨localï¼Œæ•…å°†æ‰€æœ‰çš„è¡¨æ ¼ä¿å­˜åˆ°ä¸€ä¸ªå­—å…¸ä¸­ï¼Œé”® ä¸º è¡¨åï¼Œå€¼ ä¸º è¡¨

dict_of_tables = dict()
for i in load_file:
    dict_of_tables[i.split('.')[0]] = locals()[i.split('.')[0]]     # ä½¿ç”¨forå¾ªç¯å°†æ¯ä¸€ä¸ªè¡¨éƒ½å¢åŠ åˆ°dict_of_tablesä¸­

# # 2) è¿›è¡Œå‡½æ•°å®šä¹‰

def check_distinct_column_value():

    while True:
        t_name = input('è¯·è¾“å…¥ è¡¨å ï¼š')
        c_name = input('è¯·è¾“å…¥ åˆ—å ï¼š')

        try:
            import sqlite3
            con = sqlite3.connect(':memory:')
            dict_of_tables[t_name].to_sql(t_name,con)
            c_value = pd.read_sql_query('select distinct %s from %s' % (c_name, t_name), con)
            print(c_value)
            break
        except Exception:
            print('å‘ç”Ÿé”™è¯¯ï¼Œè¯·æ£€æŸ¥æ‰€è¾“å…¥çš„ è¡¨å å’Œ åˆ—å åŠå…¶å¯¹åº”å…³ç³» æ˜¯å¦æ­£ç¡®ï¼Œå¹¶é‡æ–°è¾“å…¥')

# # 3) é€‰æ‹©æ˜¯å¦è°ƒç”¨è¯¥æŸ¥è¯¢å‡½æ•°

while True:
    answer = input('æ˜¯å¦è°ƒç”¨â€œåˆ—åå–å€¼æŸ¥çœ‹â€å‡½æ•°ï¼Ÿå›ç­” Y æˆ– Nï¼š')
    if answer == 'Y':
        check_distinct_column_value()   #å‡½æ•°è°ƒç”¨
    elif answer == 'N':
        break
    else:
        print('è¾“å…¥æœ‰è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥å›ç­”ï¼Œä»…å¯å›ç­”Y æˆ– N')
```

# -- ã€ Part 1 ä¿¡ç”¨å¡ç”¨æˆ·ç”»åƒ ã€‘ --[Â¶](#---ã€-Part-1-ä¿¡ç”¨å¡ç”¨æˆ·ç”»åƒ-ã€‘---)

# (äºŒ) æ•°æ®æ¸…æ´—åŠç»˜å›¾ ä¹‹ ä¿¡ç”¨å¡ç”¨æˆ·ç”»åƒ[Â¶](#(äºŒ)-æ•°æ®æ¸…æ´—åŠç»˜å›¾-ä¹‹-ä¿¡ç”¨å¡ç”¨æˆ·ç”»åƒ)

## 1.å°†å¯¼å…¥çš„æ–‡ä»¶æ³¨å†Œåˆ°sqlé‡Œ[Â¶](#1.å°†å¯¼å…¥çš„æ–‡ä»¶æ³¨å†Œåˆ°sqlé‡Œ)

In [ ]:

```
'''
é€šè¿‡ ä¿¡ç”¨å¡å®¢æˆ·ç”»åƒ çš„ ç›®æ ‡æ‹†è§£ å’Œ ERå›¾ï¼Œéœ€è¦ç”¨åˆ° cardã€clientsã€disp(è¿æ¥å…³ç³»ç”¨)ã€trans
æ ¹æ®ä¹‹å‰çš„æ•°æ®æŸ¥çœ‹ï¼Œè¿™ä¸‰ä¸ªè¡¨ä¸­å‡æ— ç¼ºå¤±çš„æƒ…å†µ
'''

import sqlite3
con = sqlite3.connect(':memory:')
locals()['card'].to_sql('card',con)
locals()['clients'].to_sql('clients',con)
locals()['disp'].to_sql('disp',con)
locals()['trans'].to_sql('trans',con)
```

## 2.å†™sqlè¯­å¥é€šè¿‡dispè¡¨ï¼Œå°†cardå’Œclientä¸¤ä¸ªè¡¨è¿æ¥èµ·æ¥[Â¶](#2.å†™sqlè¯­å¥é€šè¿‡dispè¡¨ï¼Œå°†cardå’Œclientä¸¤ä¸ªè¡¨è¿æ¥èµ·æ¥)

In [ ]:

```
sql_card_client = '''
SELECT cd.*,ctdp.birth_date,ctdp.district_id,ctdp.sex
FROM card AS cd JOIN (
SELECT ct.birth_date,ct.district_id,ct.sex,dp.disp_id FROM clients AS ct
JOIN disp AS dp ON ct.client_id = dp.client_id WHERE dp.type == "æ‰€æœ‰è€…")AS ctdp
ON cd.disp_id = ctdp.disp_id
'''

card_client = pd.read_sql_query(sql_card_client,con)
print(card_client)
```

## 3.ä½œå›¾ â†’ ä¿¡ç”¨å¡ä¸šåŠ¡æ€»ä½“æè¿°[Â¶](#3.ä½œå›¾-â†’-ä¿¡ç”¨å¡ä¸šåŠ¡æ€»ä½“æè¿°)

### 1) å‘å¡æ€»é‡ éš æ—¶é—´ çš„å˜åŒ–è¶‹åŠ¿[Â¶](#1)-å‘å¡æ€»é‡-éš-æ—¶é—´-çš„å˜åŒ–è¶‹åŠ¿)

In [ ]:

```
# # å› ä½œå›¾å¯èƒ½æ¶‰åŠåˆ°ä¸­æ–‡ï¼Œåœ¨æ­¤å…ˆè®¾ç½®å­—ä½“
from pylab import mpl
mpl.rcParams['font.sans-serif'] = ['SimHei']   # æŒ‡å®šé»˜è®¤å­—ä½“
mpl.rcParams['axes.unicode_minus'] = False      # è§£å†³ä¿å­˜å›¾åƒè´Ÿå·'-'æ˜¾ç¤ºä¸ºæ–¹å—çš„é—®é¢˜



# # # æ¢ç©¶ä¿¡ç”¨å¡æ€»é‡ ä¸åŒå¹´ä»½ çš„æ€»é‡å˜åŒ–
import datetime
import matplotlib.pyplot as plt

# # # æ–°å¢ä¸€åˆ—â€˜issue_yearâ€™ï¼Œæå–å‡ºå¹´ä»½
card_client['issue_year'] = pd.to_datetime(card_client['issued']).map(lambda x:x.year)

# # # åˆ›å»ºä¸€ä¸ªäº¤å‰è¡¨ï¼Œæ˜¾ç¤ºä¸åŒç±»åˆ«å¡ï¼Œä¸åŒå¹´ä»½çš„å‘è¡Œæ•°é‡
cross_tab = pd.crosstab(card_client.issue_year,card_client.type)
print(cross_tab)

# # # ç”»è¶‹åŠ¿é¢ç§¯å›¾
labels = ['é’å¹´å¡','æ™®é€šå¡','é‡‘å¡']

y1 = cross_tab.loc[:,'é’å¹´å¡'].astype('int')  # å°†'é’å¹´å¡'è¿™åˆ—çš„æ¯è¡Œçš„å­—ç¬¦éƒ½è½¬æ¢æˆint
y2 = cross_tab.loc[:,'æ™®é€šå¡'].astype('int')
y3 = cross_tab.loc[:,'é‡‘å¡'].astype('int')
x = cross_tab.index  # å°†indexåˆ—ï¼Œä¹Ÿå°±æ˜¯issue_yearè½¬æ¢æˆint

plt.stackplot(x,y1,y2,y3,labels=labels,colors=['#f89588','#3b6291','#f8cb7f'])
plt.title('ä¿¡ç”¨å¡å‘å¡é‡éšå¹´ä»½çš„æ—¶é—´å˜åŒ–è¶‹åŠ¿å›¾')
plt.legend(loc = 'upper left')  # è®¾ç½®å›¾ä¾‹ä½ç½®åœ¨å·¦ä¸Šè§’
plt.ylim(0,500)     # è®¾ç½®yè½´åˆ»åº¦æœ€å¤§å€¼

# # # è®¾ç½® æ•°å­—æ ‡ç­¾ï¼Œè¡¨æ˜å¯¹åº”çš„å‘å¡é‡
for a,b in zip(x,y1):
    plt.text(a,0.5*b-10,b,ha='center', va= 'bottom',fontsize=7)

for a,b in zip(x,y2):
    plt.text(a,0.5*b+list(y1)[list(x).index(a)]-10,b,ha='center', va= 'bottom',fontsize=7)

for a,b in zip(x,y3):
    plt.text(a,0.5*b+list(y1)[list(x).index(a)]+list(y2)[list(x).index(a)]-10,b,ha='center', va= 'bottom',fontsize=7)

plt.show()
'''
è®¾ç½® æ•°å­—æ ‡ç­¾ï¼Œæ ¼å¼ç¤ºä¾‹ï¼š
    for a,b in zip(x,y):
        plt.text(a, b+0.05, '%.0f' % b, ha='center', va= 'bottom',fontsize=7)
    aï¼šæ•°å­—æ ‡ç­¾çš„æ¨ªè½´åæ ‡
    b+0.05ï¼šæ•°å­—æ ‡ç­¾çš„çºµè½´åæ ‡
    '%.0f' % bï¼šæ ¼å¼åŒ–çš„æ•°å­—æ ‡ç­¾(ä¿ç•™ä¸€ä½å°æ•°)
    ha='center'ï¼šhorizontalalignmentï¼ˆæ°´å¹³å¯¹é½ï¼‰
    va= 'bottom'ï¼šverticalalignmentï¼ˆå‚ç›´å¯¹é½ï¼‰çš„æ–¹å¼
    fontsizeï¼šæ–‡å­—å¤§å°
æœ¬æ¡ˆä¾‹ä¸­çš„å®ä¾‹è¯´æ˜ï¼š
    å› æœ¬ä¾‹ä¸ºå †å å›¾ï¼Œæ•…å¯¹æ•°å­—æ ‡ç­¾çš„çºµè½´åæ ‡ç›¸åº”åšäº†å€¼å åŠ 
    y1å¯¹åº”çš„æ•°å­—æ ‡ç­¾çš„çºµåæ ‡æ”¾ä¸­é—´ï¼Œå¹¶ä¸‹ç§»10ï¼ˆä¸‹ç§»10æ˜¯ä¸ºäº†çœ‹èµ·æ¥æ›´ç¾è§‚ï¼‰
    y2å¯¹åº”çš„æ•°å­—æ ‡ç­¾çš„çºµåæ ‡ï¼Œè¦ä½¿å…¶åŒæ ·æ”¾ä¸­é—´ï¼Œåˆ™éœ€ç”¨y2å¯¹åº”çš„bå€¼ä¹˜ä»¥0.5å†åŠ ä¸Šy1å¯¹åº”çš„bå€¼ï¼Œå†ä¸‹ç§»10
    y3å¯¹åº”çš„æ•°å­—æ ‡ç­¾çš„çºµåæ ‡ï¼Œè¦ä½¿å…¶åŒæ ·æ”¾ä¸­é—´ï¼Œåˆ™éœ€ç”¨y3å¯¹åº”çš„bå€¼ä¹˜ä»¥0.5å†åŠ ä¸Šy1å’Œy2å¯¹åº”çš„bå€¼ï¼Œå†ä¸‹ç§»10

'''
```

![Image Name](https://cdn.kesci.com/upload/image/qbe1w3ptz8.png?imageView2/0/w/960/h/960)

### 2) ä¸åŒç±»å‹å¡æ€»å‘è¡Œé‡å æ¯”æƒ…å†µï¼ˆé¥¼å›¾ï¼‰[Â¶](#2)-ä¸åŒç±»å‹å¡æ€»å‘è¡Œé‡å æ¯”æƒ…å†µï¼ˆé¥¼å›¾ï¼‰)

In [ ]:

```
cross_tab1 = cross_tab
cross_tab1.loc['Sum'] = 0
for i in list(cross_tab):
    cross_tab1.loc['Sum'][i] = sum(cross_tab1[i])
print(cross_tab1)
plt.pie(cross_tab1.loc['Sum'],labels=list(cross_tab1),autopct='%1.1f%%',startangle=100,colors=['#3b6291','#f8cb7f','#f89588'])
plt.title('ä¸åŒç§ç±»å¡çš„å æ¯”æƒ…å†µ')
plt.show()
```

![Image Name](https://cdn.kesci.com/upload/image/qbe1witbz4.png?imageView2/0/w/960/h/960)

### è¡¥å……stack2dimåŒ…çš„ä»£ç [Â¶](#è¡¥å……stack2dimåŒ…çš„ä»£ç )

- ğŸ”º ğŸ”º ã€ è¿™é‡Œè¡¥å……ä¸‹æ¥ä¸‹æ¥æ‰€å¼•ç”¨çš„stack2dimåŒ…çš„ä»£ç ï¼š  

In [ ]:

```
# å¦‚é‡ä¸­æ–‡æ˜¾ç¤ºé—®é¢˜å¯åŠ å…¥ä»¥ä¸‹ä»£ç 
from pylab import mpl

mpl.rcParams['font.sans-serif'] = ['SimHei']  # æŒ‡å®šé»˜è®¤å­—ä½“
mpl.rcParams['axes.unicode_minus'] = False  # è§£å†³ä¿å­˜å›¾åƒæ˜¯è´Ÿå·'-'æ˜¾ç¤ºä¸ºæ–¹å—çš„é—®é¢˜


def stack2dim(raw, i, j, rotation=0, location='upper right'):
    '''
    æ­¤å‡½æ•°æ˜¯ä¸ºäº†ç”»ä¸¤ä¸ªç»´åº¦æ ‡å‡†åŒ–çš„å †ç§¯æŸ±çŠ¶å›¾
    rawä¸ºpandasçš„DataFrameæ•°æ®æ¡†
    iã€jä¸ºä¸¤ä¸ªåˆ†ç±»å˜é‡çš„å˜é‡åç§°ï¼Œè¦æ±‚å¸¦å¼•å·ï¼Œæ¯”å¦‚"school"
    rotationï¼šæ°´å¹³æ ‡ç­¾æ—‹è½¬è§’åº¦ï¼Œé»˜è®¤æ°´å¹³æ–¹å‘ï¼Œå¦‚æ ‡ç­¾è¿‡é•¿ï¼Œå¯è®¾ç½®ä¸€å®šè§’åº¦ï¼Œæ¯”å¦‚è®¾ç½®rotation = 40
    locationï¼šåˆ†ç±»æ ‡ç­¾çš„ä½ç½®ï¼Œå¦‚æœè¢«ä¸»ä½“å›¾å½¢æŒ¡ä½ï¼Œå¯æ›´æ”¹ä¸º'upper left'
    '''
    import matplotlib.pyplot as plt
    import pandas as pd
    import numpy as np
    import math

    data_raw = pd.crosstab(raw[i], raw[j])
    data = data_raw.div(data_raw.sum(1), axis=0)  # äº¤å‰è¡¨è½¬æ¢æˆæ¯”ç‡ï¼Œä¸ºå¾—åˆ°æ ‡å‡†åŒ–å †ç§¯æŸ±çŠ¶å›¾

    # è®¡ç®—xåæ ‡ï¼ŒåŠbarå®½åº¦
    createVar = locals()
    x = [0]  # æ¯ä¸ªbarçš„ä¸­å¿ƒxè½´åæ ‡
    width = []  # barçš„å®½åº¦
    k = 0
    for n in range(len(data)):
        # æ ¹æ®é¢‘æ•°è®¡ç®—æ¯ä¸€åˆ—barçš„å®½åº¦
        createVar['width' + str(n)] = list(data_raw.sum(axis=1))[n] / sum(data_raw.sum(axis=1))
        width.append(createVar['width' + str(n)])
        if n == 0:
            continue
        else:
            k += createVar['width' + str(n - 1)] / 2 + createVar['width' + str(n)] / 2 + 0.05
            x.append(k)

    # ä»¥ä¸‹æ˜¯é€šè¿‡é¢‘ç‡äº¤å‰è¡¨çŸ©é˜µç”Ÿæˆä¸€ä¸²å¯¹åº”å †ç§¯å›¾æ¯ä¸€å—ä½ç½®æ•°æ®çš„æ•°ç»„ï¼Œå†æŠŠæ•°ç»„è½¬åŒ–ä¸ºçŸ©é˜µ
    y_mat = []
    n = 0
    y_level = len(data.columns)
    for p in range(data.shape[0]):
        for q in range(data.shape[1]):
            n += 1
            y_mat.append(data.iloc[p, q])
            if n == data.shape[0] * data.shape[1]:
                break
            elif n % y_level != 0:
                y_mat.extend([0] * (len(data) - 1))
            elif n % y_level == 0:
                y_mat.extend([0] * len(data))

    y_mat = np.array(y_mat).reshape(-1, len(data))
    y_mat = pd.DataFrame(y_mat)  # barå›¾ä¸­çš„yå˜é‡çŸ©é˜µï¼Œæ¯ä¸€è¡Œæ˜¯ä¸€ä¸ªyå˜é‡

    # é€šè¿‡xï¼Œy_matä¸­çš„æ¯ä¸€è¡Œyï¼Œä¾æ¬¡ç»˜åˆ¶æ¯ä¸€å—å †ç§¯å›¾ä¸­çš„æ¯ä¸€å—å›¾

    from matplotlib import cm
    cm_subsection = [level for level in range(y_level)]
    colors = [cm.Pastel1(color) for color in cm_subsection]

    bottom = [0] * y_mat.shape[1]
    createVar = locals()
    for row in range(len(y_mat)):
        createVar['a' + str(row)] = y_mat.iloc[row, :]
        color = colors[row % y_level]

        if row % y_level == 0:
            bottom = bottom = [0] * y_mat.shape[1]
            if math.floor(row / y_level) == 0:
                label = data.columns.name + ': ' + str(data.columns[row])
                plt.bar(x, createVar['a' + str(row)],
                        width=width[math.floor(row / y_level)], label=label, color=color)
            else:
                plt.bar(x, createVar['a' + str(row)],
                        width=width[math.floor(row / y_level)], color=color)
        else:
            if math.floor(row / y_level) == 0:
                label = data.columns.name + ': ' + str(data.columns[row])
                plt.bar(x, createVar['a' + str(row)], bottom=bottom,
                        width=width[math.floor(row / y_level)], label=label, color=color)
            else:
                plt.bar(x, createVar['a' + str(row)], bottom=bottom,
                        width=width[math.floor(row / y_level)], color=color)

        bottom += createVar['a' + str(row)]

    plt.title(j + ' vs ' + i)
    group_labels = [str(name) for name in data.index]
    plt.xticks(x, group_labels, rotation=rotation)
    plt.ylabel(j)
    plt.legend(shadow=True, loc=location)
    plt.show()
```

- è¡¥å……ç»“æŸ ã€‘ ğŸ”º ğŸ”º
  \## 4.åŸºæœ¬å±æ€§ç‰¹å¾  

### 1) ä¸åŒå¡ç±»å‹çš„æ€§åˆ«æ¯”è¾ƒå †ç§¯å›¾[Â¶](#1)-ä¸åŒå¡ç±»å‹çš„æ€§åˆ«æ¯”è¾ƒå †ç§¯å›¾)

In [ ]:

```
from stack2dim import *
stack2dim(card_client,'type','sex')
```

![Image Name](https://cdn.kesci.com/upload/image/qbe1xak0lw.png?imageView2/0/w/960/h/960)

### 2) ä¸åŒå¡ç±»å‹çš„å¹´é¾„æ¯”è¾ƒ[Â¶](#2)-ä¸åŒå¡ç±»å‹çš„å¹´é¾„æ¯”è¾ƒ)

In [ ]:

```
import seaborn as sns
import time
card_client['age']=(pd.to_datetime(card_client['issued'])-pd.to_datetime(card_client['birth_date']))

card_client['age1']=card_client['age'].map(lambda x:x.days/365)
ax_age = sns.boxplot(x = 'type', y = 'age1', data = card_client,palette=sns.xkcd_palette(['gold','windows blue','coral']))
ax_age.set_title('ä¸åŒå¡ç±»å‹çš„ å¹´é¾„ æ¯”è¾ƒ')
plt.show()
```

![Image Name](https://cdn.kesci.com/upload/image/qbe21qfamz.png?imageView2/0/w/960/h/960)

### 3) ä¸åŒç±»å‹å¡çš„æŒå¡äººåœ¨åŠå¡å‰ä¸€å¹´å†…çš„å¹³å‡å¸æˆ·ä½™é¢å¯¹æ¯”[Â¶](#3)-ä¸åŒç±»å‹å¡çš„æŒå¡äººåœ¨åŠå¡å‰ä¸€å¹´å†…çš„å¹³å‡å¸æˆ·ä½™é¢å¯¹æ¯”)

In [ ]:

```
sql_card_client_trans = '''
select a.card_id,a.issued,a.type,c.type as t_type,c.amount,c.balance,c.date as t_date
  from card as a
  left join disp as b on a.disp_id=b.disp_id
  left join trans as c on b.account_id=c.account_id
  where b.type="æ‰€æœ‰è€…"
  order by a.card_id,c.date
'''
card_client_trans = pd.read_sql_query(sql_card_client_trans,con)
# print(card_client_trans.head())

# # æ ‡å‡†åŒ–æ—¥æœŸ
card_client_trans['issued']=pd.to_datetime(card_client_trans['issued'])
card_client_trans['t_date']=pd.to_datetime(card_client_trans['t_date'])
print(card_client_trans)

# # å¯¹å¸æˆ·ä½™é¢è¿›è¡Œæ¸…æ´—ï¼šå»æ‰é‡‘é¢å•ä½å’Œé€—å·åˆ†éš”ï¼Œä¾¿äºè®¡ç®—
card_client_trans['balance_1'] = card_client_trans['balance'].map(lambda x:int(x.strip('$').replace(',','')))
print(card_client_trans)

# # ç­›é€‰å‡ºå¼€å¡å‰ä¸€å¹´çš„æ•°æ®
card_client_trans_1 = card_client_trans[card_client_trans.issued > card_client_trans.t_date][
    card_client_trans.t_date >= card_client_trans.issued-datetime.timedelta(days=365)
]
print(card_client_trans_1)

# #  åˆ†ç»„è®¡ç®—ä½™é¢å‡å€¼
card_client_trans_1['avg_balance'] = card_client_trans_1.groupby('card_id')['balance_1'].mean()
card_client_trans_2 = card_client_trans_1.groupby(['type','card_id'])['balance_1'].agg([('avg_balance','mean')])
# print(card_client_trans_1)
# print(card_client_trans_2)
card_client_trans_2.to_sql('card_client_trans_2',con)
card_client_trans_3 = card_client_trans_2.reset_index()
card_client_trans_3 = pd.read_sql('select * from card_client_trans_2', con)

colors = ['windows blue','gold','coral']
ax_balance = sns.boxplot(x='type',y='avg_balance',data=card_client_trans_3,palette=sns.xkcd_palette(colors))
ax_balance.set_title('ä¸åŒç±»å‹å¡çš„æŒå¡äººåœ¨åŠå¡å‰ä¸€å¹´å†…çš„ å¹³å‡å¸æˆ·ä½™é¢ å¯¹æ¯”')
plt.show()
```

![Image Name](https://cdn.kesci.com/upload/image/qbe22vazt1.png?imageView2/0/w/960/h/960)

### 4) ä¸åŒç±»å‹æŒå¡äººåœ¨åŠå¡å‰ä¸€å¹´å†…çš„å¹³å‡æ”¶å…¥å’Œå¹³å‡æ”¯å‡ºå¯¹æ¯”[Â¶](#4)-ä¸åŒç±»å‹æŒå¡äººåœ¨åŠå¡å‰ä¸€å¹´å†…çš„å¹³å‡æ”¶å…¥å’Œå¹³å‡æ”¯å‡ºå¯¹æ¯”)

In [ ]:

```
# # 

# # # å…ˆå°† å€Ÿã€è´· è½¬æ¢æˆ æ›´æ˜“ç†è§£çš„ outã€income
type_dict = {'å€Ÿ':'out','è´·':'income'}
card_client_trans_1['type_1'] = card_client_trans_1.t_type.map(type_dict)

# # # å°†amounté‡‘é¢åˆ—çš„ é‡‘é¢å•ä½ å’Œ é€—å·åˆ†éš” å»æ‰
card_client_trans_1['amount_1'] = card_client_trans_1['amount'].apply(lambda x:int(x.strip('$').replace(',','')))

card_client_trans_4 = card_client_trans_1.groupby(['type','card_id','type_1'])[['amount_1']].sum()
card_client_trans_4.head()
card_client_trans_4.to_sql('card_client_trans_4',con)

card_client_trans_5 = card_client_trans_4.reset_index()
card_client_trans_5.to_sql('card_client_trans_5',con)
card_client_trans_6 = pd.read_sql_query('select * from card_client_trans_5 where type_1 = "income"',con)

ax_amount_income = sns.boxplot(x='type',y='amount_1',data=card_client_trans_6,palette=sns.xkcd_palette(['gold','windows blue','coral']))
ax_amount_income.set_title('ä¸åŒç±»å‹æŒå¡äººåœ¨åŠå¡å‰ä¸€å¹´å†…çš„ å¹³å‡æ”¶å…¥ å¯¹æ¯”')
plt.show()

card_client_trans_7 = pd.read_sql_query('select * from card_client_trans_5 where type_1 = "out"',con)
ax_amount_out = sns.boxplot(x='type',y='amount_1',data=card_client_trans_6,palette=sns.xkcd_palette(['gold','windows blue','coral']))
ax_amount_out.set_title('ä¸åŒç±»å‹æŒå¡äººåœ¨åŠå¡å‰ä¸€å¹´å†…çš„ å¹³å‡æ”¯å‡º å¯¹æ¯”')
plt.show()
```

![Image Name](https://cdn.kesci.com/upload/image/qbe24sry08.png?imageView2/0/w/960/h/960)

![Image Name](https://cdn.kesci.com/upload/image/qbe28pnfwu.png?imageView2/0/w/960/h/960)

In [ ]:

```
'''
ã€ä¿¡ç”¨å¡å®¢æˆ·ç”»åƒæ€»ç»“åˆ†æã€‘ï¼š
ï¼ˆä¸€ï¼‰æ€»ä½“è¶‹åŠ¿ï¼ˆè¿‘å…­å¹´ï¼‰ï¼š
    1.é€å¹´å‘å¡é‡ï¼šé‡‘å¡ã€æ™®é€šå¡å‡å‘ˆé€å¹´ä¸Šå‡è¶‹åŠ¿ï¼Œé’å¹´å¡åœ¨1997å¹´çš„å‘è¡Œé‡åŒæ¯”é™ä½ï¼Œä½†æ€»ä½“ä¸ºä¸Šå‡è¶‹åŠ¿ï¼›
                é€å¹´å‘è¡Œé‡å æ¯”æ’åä¸ºï¼šæ™®é€šå¡ > é’å¹´å¡ > é‡‘å¡
    2.æ€»å‘å¡é‡ï¼šæ€»ä½“å‘å¡é‡å æ¯”æ’åä¸ºï¼šæ™®é€šå¡ > é’å¹´å¡ > é‡‘å¡,å…¶ä¸­æ™®é€šå¡å æ¯”æ¥è¿‘æ€»å‘å¡é‡çš„3/4
ï¼ˆäºŒï¼‰åŸºæœ¬å±æ€§ç‰¹å¾
    1.ä¸åŒå¡ç±»å‹çš„ æ€§åˆ« æ¯”è¾ƒï¼š
        æ™®é€šå¡å’Œé’å¹´å¡ ç”·å¥³æ€§æ¯”ä¾‹è¾ƒä¸ºå‡è¡¡ï¼ŒåŸºæœ¬ä¸º1ï¼š1ï¼›é‡‘å¡çš„ç”·æ€§æŒæœ‰è€…æ¯”ä¾‹ç›¸è¾ƒå¥³æ€§æŒæœ‰è€…æ˜æ˜¾æ›´å¤š
    2.ä¸åŒå¡ç±»å‹çš„ å¹´é¾„ æ¯”è¾ƒ:
        æ™®é€šå¡å’Œé‡‘å¡çš„æŒæœ‰è€…å¹´é¾„ä¸»è¦é›†ä¸­åœ¨30~60å²ä¹‹é—´ï¼›è€Œé’å¹´å¡åˆ™æ™®éé›†ä¸­åœ¨25å²ä»¥å†…ï¼Œå¡ç±»å‹è®¾è®¡ä¸ç›®æ ‡å¯¹è±¡ç›¸ç¬¦
    3.ä¸åŒç±»å‹å¡çš„æŒå¡äººåœ¨åŠå¡å‰ä¸€å¹´å†…çš„ å¹³å‡å¸æˆ·ä½™é¢ å¯¹æ¯”ï¼š
        é‡‘å¡æŒæœ‰è€…çš„åŠå¡å‰ä¸€å¹´çš„ å¹³å‡ä½™é¢ æ˜¯è¦æ˜¾è‘—é«˜äº æ™®é€šå¡ å’Œ é’å¹´å¡ çš„ï¼Œå¡ç±»å‹è®¾è®¡ä¸ç›®æ ‡å¯¹è±¡ç›¸ç¬¦
    4.ä¸åŒç±»å‹æŒå¡äººåœ¨åŠå¡å‰ä¸€å¹´å†…çš„ å¹³å‡æ”¶å…¥å’Œå¹³å‡æ”¯å‡º å¯¹æ¯”ï¼š
        ä¸‰ç§ç±»å‹çš„ å¹³å‡æ”¶å…¥ã€å¹³å‡æ”¯å‡º æ’åºå‡ç¬¦åˆï¼šé‡‘å¡ > æ™®é€šå¡ > é’å¹´å¡ï¼Œé‡‘å¡çš„æŒæœ‰äººç¾¤ä¸ºæ”¶å…¥è¾ƒé«˜çš„ç¾¤ä½“ï¼Œ
        åŒæ ·å…¶æ”¯å‡ºæƒ…å†µä¹Ÿç›¸åº”é«˜äºæ™®é€šæŒå¡äººç¾¤ï¼Œè€Œé’å¹´å¡ï¼Œç”±äºå…¶æŒå¡äººç¾¤å¤šä¸ºå¹´é¾„å±‚è¾ƒå°çš„äººç¾¤ï¼Œæ”¶å…¥æ”¯å‡ºå‡è¾ƒä½ï¼Œ
        å¡ç±»å‹è®¾è®¡ä¸ç›®æ ‡å¯¹è±¡æƒ…å†µç›¸ç¬¦
'''
```

# -- ã€ Part 2 è´·æ¬¾è¿çº¦é¢„æµ‹æ¨¡å‹ ã€‘ --[Â¶](#---ã€-Part-2-è´·æ¬¾è¿çº¦é¢„æµ‹æ¨¡å‹-ã€‘---)

# (ä¸‰) æ•°æ®æ¸…æ´— ä¹‹ è´·æ¬¾è¿çº¦é¢„æµ‹æ¨¡å‹[Â¶](#(ä¸‰)-æ•°æ®æ¸…æ´—-ä¹‹-è´·æ¬¾è¿çº¦é¢„æµ‹æ¨¡å‹)

'''
1.æ—¶é—´ç‚¹çš„é€‰æ‹©ï¼šé€‰å–æ”¾æ¬¾æ—¶é—´ç‚¹ä¹‹å‰çš„ä¸€å¹´ï¼Œè§‚å¯Ÿç”¨æˆ·æ˜¯å¦æœ‰é€¾æœŸè¡Œä¸º
2.loansè¡¨ä¸­çš„è´·æ¬¾çŠ¶æ€è¯´æ˜ï¼šAä»£è¡¨åˆåŒç»ˆæ­¢ï¼Œæ²¡é—®é¢˜ï¼›Bä»£è¡¨åˆåŒç»ˆæ­¢ï¼Œè´·æ¬¾æ²¡æœ‰æ”¯ä»˜ï¼›
                        Cä»£è¡¨åˆåŒå¤„äºæ‰§è¡ŒæœŸï¼Œè‡³ä»Šæ­£å¸¸ï¼›Dä»£è¡¨åˆåŒå¤„äºæ‰§è¡ŒæœŸï¼Œæ¬ å€ºçŠ¶æ€ã€‚
                        Aè´·æ¬¾æ­£å¸¸è¿˜æ¬¾ï¼ŒBã€Dæœ‰é—®é¢˜ï¼ŒCå¾…å®š
'''

## 1.ç”¨æˆ·ä¿¡æ¯ â†’ å°† æ€§åˆ«ã€å¹´é¾„ã€ä¿¡ç”¨å¡ä¿¡æ¯ æ·»åŠ åˆ°loansè¡¨ä¸­[Â¶](#1.ç”¨æˆ·ä¿¡æ¯-â†’-å°†-æ€§åˆ«ã€å¹´é¾„ã€ä¿¡ç”¨å¡ä¿¡æ¯-æ·»åŠ åˆ°loansè¡¨ä¸­)

In [ ]:

```
# # 1)åœ¨loansè¡¨ä¸­å¢åŠ ä¸€åˆ—ï¼Œç”¨æ•°å­—æ¥ä»£æ›¿è´·æ¬¾çŠ¶æ€ï¼Œæ–¹ä¾¿åç»­åˆ†æ

loan_status = {'B':1,'D':1,'A':0,'C':2}
locals()['loans']['loan_status'] = locals()['loans']['status'].map(loan_status)
print(locals()['loans'])

# # 2) è¿›è¡Œåˆ—æ·»åŠ 
'''
é€šè¿‡dispè¡¨è¿æ¥loansè¡¨å’Œclientsè¡¨
'''
data_1 = pd.merge(locals()['loans'],locals()['disp'],on='account_id',how='left')
data_2 = pd.merge(data_1,locals()['clients'],on='client_id',how='left')
data_3 = data_2[data_2.type == 'æ‰€æœ‰è€…']


# # å¢åŠ å¹´é¾„åˆ—
# # # é¦–å…ˆå°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºdatetimeæ—¶é—´åºåˆ—ï¼Œå†è®¡ç®—å‡ºå¹´é¾„
data_3['age_temp'] = (pd.to_datetime(data_3['date'])-pd.to_datetime(data_3['birth_date']))
data_3['age'] = data_3['age_temp'].map(lambda x:round(x.days/365,0))


# # è¿æ¥cardè¡¨
data_4 = pd.merge(data_3,locals()['card'],on='disp_id',how='left')
```

## 2.çŠ¶æ€ä¿¡æ¯ â†’ å°† ç›¸å…³åˆ—æ·»åŠ [Â¶](#2.çŠ¶æ€ä¿¡æ¯-â†’-å°†-ç›¸å…³åˆ—æ·»åŠ )

In [ ]:

```
# # 1)æ·»åŠ åœ°åŒºçŠ¶æ€ä¿¡æ¯
data_5 = pd.merge(data_4,locals()['district'],left_on='district_id',right_on='A1',how='left')

# # # å°†éœ€è¦çš„åˆ—ç­›é€‰å‡ºæ¥
trans_clients_district = data_5[['account_id','amount','duration','payments','loan_status','type_y','sex',
                                 'age', 'district_id','GDP','A4','A10','A11','A12','A13','A14','A15','a16']]


# # 2) å®¢æˆ·ä¸ªäººç»æµçŠ¶å†µä¿¡æ¯
trans_loans = pd.merge(locals()['trans'],locals()['loans'],on='account_id')
print(trans_loans.head())
print(list(trans_loans))
'''
åˆå¹¶åå‡ºç°çš„åˆ—ååå¸¦_xå’Œ_yæ˜¯å› ä¸ºåˆå¹¶çš„ä¸¤å¼ è¡¨ä¸­æœ‰æœ‰ç›¸åŒçš„åˆ—åï¼Œä¸ºç¤ºåŒºåˆ†åŠ ä¸Šçš„åç¼€ï¼›
_xè¡¨ç¤ºçš„æ˜¯åˆå¹¶å‰'trans'è¡¨ä¸­çš„åˆ—ï¼Œ_yè¡¨ç¤ºçš„æ˜¯åˆå¹¶å‰'loans'è¡¨ä¸­çš„åˆ—
'''
```

## 3.ç­›é€‰æ•°æ®[Â¶](#3.ç­›é€‰æ•°æ®)

In [ ]:

```
# # ç­›é€‰å‡ºè´·æ¬¾å‰ä¸€å¹´çš„äº¤æ˜“æ•°æ®
trans_loans['date_x'] = pd.to_datetime(trans_loans['date_x'])
trans_loans['date_y'] = pd.to_datetime(trans_loans['date_y'])

# # å°† amount_x å’Œ balance ç”±å­—ç¬¦ä¸²ç±»å‹ï¼Œå»æ‰$ç¬¦å·å’Œé€—å·åˆ†éš”ï¼Œè½¬åŒ–ä¸ºæ•°å€¼ç±»å‹
trans_loans['amount_x'] = trans_loans['amount_x'].apply(lambda x:int(x.strip('$').replace(',','')))
trans_loans['balance'] = trans_loans['balance'].apply(lambda x:int(x.strip('$').replace(',','')))

# # ç­›é€‰å‡ºæ”¾æ¬¾æ—¥æœŸæŒ‰1å¹´å†…è‡³å‰ä¸€å¤©çš„äº¤æ˜“è®°å½•
trans_loans = trans_loans[(trans_loans['date_x']<trans_loans['date_y'])&((trans_loans['date_x']+datetime.timedelta(days=365))>trans_loans['date_y'])]

# # ç­›é€‰ç”¨æˆ·å‰ä¸€å¹´å†…ç»“æ¯æ€»é¢
trans_loans_1 = trans_loans[trans_loans['k_symbol']=='åˆ©æ¯æ‰€å¾—']
trans_loans_1 = pd.DataFrame(trans_loans_1.groupby('account_id')['amount_x'].sum())
trans_loans_1.columns = ['interest']

# # ç­›é€‰åœ¨æœ¬è¡Œæ˜¯å¦ç”±å…»è€é‡‘å’Œæˆ¿å±‹è´·æ¬¾
trans_loans_2 = trans_loans[(trans_loans['k_symbol']=='å…»è€é‡‘')|(trans_loans['k_symbol']=='æˆ¿å±‹è´·æ¬¾')]

# # æ ‡è®°æ˜¯å¦åœ¨æœ¬è¡Œæœ‰æˆ¿å±‹è´·æ¬¾
trans_loans_2 = pd.DataFrame(trans_loans_2.groupby('account_id')['k_symbol'].count())
trans_loans_2['house_loan'] = '1'
del trans_loans_2['k_symbol']

# # ç­›é€‰å®¢æˆ·ä¸€å¹´å†…æ”¶å…¥å’Œæ”¯å‡ºï¼ˆæ€»å’Œï¼‰
print(trans_loans_2.head())
trans_loans_3 = pd.DataFrame(trans_loans.pivot_table(values='amount_x',index='account_id',columns='type'))
trans_loans_3.columns = ['out','income']

# # ç­›é€‰å®¢æˆ·ä¸€å¹´å†…ä½™é¢çš„å‡å€¼å’Œæ ‡å‡†å·®
trans_loans_4 = pd.DataFrame(trans_loans.groupby('account_id')['balance'].agg(['mean','std']))
trans_loans_4.columns = ['balance_mean','balance_std']

# # åˆå¹¶æ•°æ®
data_temp = pd.merge(trans_loans_1,trans_loans_2,how='left',left_index=True,right_index=True)
data_temp = pd.merge(data_temp,trans_loans_3,left_index=True,right_index=True)
data_temp = pd.merge(data_temp,trans_loans_4,left_index=True,right_index=True)
print(len(data_temp)) # æŸ¥çœ‹æ•°æ®æ¡æ•°æ˜¯å¦ä¸è´·æ¬¾è¡¨æ¡æ•°ä¸€è‡´
data_model = pd.merge(trans_clients_district,data_temp,left_on='account_id',right_index=True)
print(data_model)
```

# (å››) æ¨¡å‹æ„å»º[Â¶](#(å››)-æ¨¡å‹æ„å»º)

## 1. æ•°æ®æ¸…æ´— åŠ å˜é‡é€‰æ‹©[Â¶](#1.-æ•°æ®æ¸…æ´—-åŠ-å˜é‡é€‰æ‹©)

### 1) æŸ¥çœ‹æ•°æ®ç¼ºå¤±æƒ…å†µ[Â¶](#1)-æŸ¥çœ‹æ•°æ®ç¼ºå¤±æƒ…å†µ)

In [ ]:

```
print(data_model.isnull().sum()/len(data_model))
'''
åˆ†æç¼ºå¤±æƒ…å†µã€åŸå› åŠå¤„ç†ï¼š
    æ€»å…±æœ‰ åˆ—å­˜åœ¨ç¼ºå¤±ä¿¡æ¯
    type_yï¼šç¼ºå¤±ä¿¡æ¯æ¥è¿‘75%ï¼Œä¿¡æ¯ç¼ºå¤±è¿‡å¤šï¼Œåˆ é™¤åˆ—ï¼›
    A12 å’Œ A15ï¼šA12 1995å¹´å¤±ä¸šç‡ å’Œ A15 1995çŠ¯ç½ªç‡(åƒäºº) æœ‰æå°éƒ¨åˆ†æ•°æ®ç¼ºå¤±ï¼Œå› ä¸ºæ˜¯è¿ç»­æ•°æ®ï¼Œä½¿ç”¨ä¸­ä½æ•°å¡«å……ï¼›
    house_loanï¼šæ˜¯å¦æœ‰æˆ¿å±‹è´·æ¬¾ï¼Œç¼ºå¤±å€¼ä¸ºæ²¡æœ‰æˆ¿å±‹è´·æ¬¾ï¼Œå¡«å……å­—ç¬¦â€˜0â€™
'''
```

### 2) æ•°æ®å¤„ç†[Â¶](#2)-æ•°æ®å¤„ç†)

In [ ]:

```
del data_model['type_y']
data_model['A12'].fillna(data_model['A12'].median(),inplace=True)
data_model['A15'].fillna(data_model['A15'].median(),inplace=True)
data_model['house_loan'].fillna('0',inplace=True)
```

### 3) å¯¹å˜é‡è¿›è¡Œåˆ†ç±»[Â¶](#3)-å¯¹å˜é‡è¿›è¡Œåˆ†ç±»)

In [ ]:

```
# # # <1> å› å˜é‡
y = 'loan_status'

# # # <2> è¿ç»­å˜é‡
var_c =  ['amount', 'duration', 'payments', 'GDP',
       'A4', 'A10', 'A11', 'A12', 'A13', 'A14', 'A15', 'a16', 'age',
       'interest', 'out', 'income', 'balance_mean',
       'balance_std']

# # # <3> åˆ†ç±»å˜é‡
var_d = ['sex','house_loan']

# # # # å¯¹ sex å’Œ house_loan ä¸¤ä¸ªåˆ†ç±»å˜é‡äºŒå€¼åŒ–ï¼Œæ–¹ä¾¿åˆ†æ
data_model['sex_kind'] = data_model['sex'].map({'ç”·':1,'å¥³':0})
data_model['house_loan_kind'] = data_model['house_loan'].map({'1':1,'0':0})
```

### 4) ä½¿ç”¨ çƒ­åŠ›å›¾ æŸ¥çœ‹ä¸ªå˜é‡é—´çš„å…³ç³»[Â¶](#4)-ä½¿ç”¨-çƒ­åŠ›å›¾-æŸ¥çœ‹ä¸ªå˜é‡é—´çš„å…³ç³»)

In [ ]:

```
import matplotlib.pyplot as plt
import seaborn as sns

corr = data_model[var_c+var_d].corr()
plt.figure(figsize=(12,9))  # æŒ‡å®šå®½å’Œé«˜ï¼ˆå•ä½ï¼šè‹±å¯¸ï¼‰
sns.heatmap(corr,vmax=1,annot=True) # vmaxè®¾ç½®çƒ­åŠ›å›¾é¢œè‰²å–å€¼çš„æœ€å¤§å€¼ï¼›annotè®¾ç½®æ˜¯å¦æ˜¾ç¤ºæ ¼å­æ•°å­—
plt.show()
```

![Image Name](https://cdn.kesci.com/upload/image/qbe26cbtlr.png?imageView2/0/w/960/h/960)

### 5) é€‰æ‹©æœ€ç»ˆæ¨¡å‹ä½¿ç”¨çš„å˜é‡[Â¶](#5)-é€‰æ‹©æœ€ç»ˆæ¨¡å‹ä½¿ç”¨çš„å˜é‡)

In [ ]:

```
'''
ä»çƒ­åŠ›å›¾è§‚å¯Ÿå¯çŸ¥ï¼š
    è´·æ¬¾ä¿¡æ¯ã€å±…ä½åœ°ä¿¡æ¯ã€ç»æµçŠ¶å†µä¿¡æ¯å†…å„å˜é‡å…·æœ‰é«˜ç›¸å…³æ€§ï¼Œå¯¹å˜é‡è¿›è¡Œç­›é€‰åŠè½¬æ¢
    1. è´·æ¬¾ä¿¡æ¯ä¸­ï¼šä¿ç•™amount
    2. å±…ä½åœ°ä¿¡æ¯ï¼š
                1) é‡‡ç”¨äººå‡GDPï¼Œå³å¯¹å˜é‡è¿›è¡Œè½¬æ¢ï¼›
                2) é‡‡ç”¨å¤±ä¸šå¢é•¿ç‡
    3. ç»æµçŠ¶å†µä¿¡æ¯ï¼š
                1) å®¢æˆ·æ”¾æ¬¾å‰è¿‘ä¸€å¹´æ€»ç»“æ¯ï¼ˆååº”å®é™…å­˜æ¬¾æ•°é¢ï¼‰
                2) æ”¶æ”¯æ¯”ï¼ˆååº”å®¢æˆ·æ¶ˆè´¹æ°´å¹³ï¼‰
                3) å¯ç”¨ä½™é¢å˜å¼‚ç³»æ•°ï¼ˆååº”å®¢æˆ·ç”Ÿæ´»çŠ¶æ€ç¨³å®šç³»æ•°ï¼‰
'''

data_model['GDP_per'] = data_model['GDP']/data_model['A4']  # äººå‡GDPäººæ°‘ç”Ÿæ´»æ°´å¹³çš„ä¸€ä¸ªæ ‡å‡†
data_model['unemployment'] = data_model['A13']/data_model['A12']    # å¤±ä¸šå¢é•¿ç‡ä¸€å®šç¨‹åº¦ä¸Šååº”ç»æµå¢é•¿ç‡
data_model['out/in'] =  data_model['out']/data_model['income']  # æ¶ˆè´¹å æ”¶å…¥æ¯”é‡ï¼Œä¸€å®šç¨‹åº¦ååº”å®¢æˆ·æ¶ˆè´¹æ°´å¹³
data_model['balance_a']  =  data_model['balance_std']/data_model['balance_mean']    # å¯ç”¨ä½™é¢å˜å¼‚ç³»æ•°
var = ['account_id','sex_kind','age','amount','GDP_per','unemployment','out/in','balance_a']
# print(data_model)
# print(list(data_model))
```

## 2. é€»è¾‘å›å½’æ„å»º[Â¶](#2.-é€»è¾‘å›å½’æ„å»º)

In [ ]:

```
data_model = data_model[var+[y]]
for_predict = data_model[data_model[y]==2]  # loan_status ä¸º2è¡¨ç¤ºçŠ¶æ€Cï¼Œå³ï¼šå¾…å®š
data_model = data_model[data_model[y]!=2]

# # å®šä¹‰è‡ªå˜é‡å’Œå› å˜é‡
import numpy as np
X = data_model[var]
Y = data_model[y]

# # å°†æ ·æœ¬æ•°æ®å»ºç«‹è®­ç»ƒé›†å’Œæµ‹è¯•é›†ï¼Œæµ‹è¯•é›†å–20%çš„æ•°æ®
from sklearn.model_selection import train_test_split
x_train, x_test, y_train, y_test = train_test_split(X, Y, test_size = 0.2, random_state = 1234)
```

## 3. å»ºæ¨¡(ä½¿ç”¨é€»è¾‘å›å½’L1æ­£åˆ™åŒ–å‚æ•°)[Â¶](#3.-å»ºæ¨¡(ä½¿ç”¨é€»è¾‘å›å½’L1æ­£åˆ™åŒ–å‚æ•°))

In [ ]:

```
from sklearn.linear_model import LogisticRegression

LR = LogisticRegression(penalty='l1',solver='liblinear')
var_temp = ['sex_kind','age','amount','GDP_per','unemployment','out/in','balance_a']
x_train_temp = x_train[var_temp]
clf = LR.fit(x_train_temp,y_train) # æ‹Ÿåˆ

x_test_temp = x_test[var_temp]
y_pred = clf.predict(x_test_temp)   # é¢„æµ‹æµ‹è¯•é›†æ•°æ®
test_result = pd.DataFrame({'account_id':x_test['account_id'],'y_predict':clf.predict(x_test_temp)})
new_test_result = test_result.reset_index(drop=True)
print(test_result)  # è¾“å‡ºæµ‹è¯•é›†ä¸­ account_id å¯¹åº”çš„è´·æ¬¾çŠ¶æ€é¢„æµ‹
print(new_test_result)  # è¾“å‡ºæµ‹è¯•é›†ä¸­ account_id å¯¹åº”çš„è´·æ¬¾çŠ¶æ€é¢„æµ‹


print(clf.coef_)    #æŸ¥çœ‹å„å˜é‡çš„å›å½’ç³»æ•°
```

## 4. å»ºæ¨¡ç»“æœè¯„ä»·[Â¶](#4.-å»ºæ¨¡ç»“æœè¯„ä»·)

In [ ]:

```
from sklearn.metrics import classification_report
print(classification_report(y_test, y_pred))
'''
æ¨¡å‹çš„ç²¾ç¡®ç‡0.87ï¼Œå¬å›ç‡0.84ï¼Œf1_scoreä¸º0.82
'''
```

## 5. ç»˜åˆ¶ROCæ›²çº¿[Â¶](#5.-ç»˜åˆ¶ROCæ›²çº¿)

In [ ]:

```
from sklearn.metrics import roc_curve, auc
fpr, tpr, threshold = roc_curve(y_test, y_pred)
roc_auc = auc(fpr, tpr)
plt.plot(fpr, tpr, color='darkorange',label='ROC curve (area = %0.2f)' % roc_auc)
plt.plot([0, 1], [0, 1], color='navy',  linestyle='--')
plt.xlim([0.0, 1.0])
plt.ylim([0.0, 1.0])
plt.xlabel('False Positive Rate')
plt.ylabel('True Positive Rate')
plt.title('ROC_curve')
plt.legend(loc="lower right")
plt.show()
```

![Image Name](https://cdn.kesci.com/upload/image/qbe272hidt.png?imageView2/0/w/960/h/960)